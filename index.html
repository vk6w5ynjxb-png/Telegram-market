<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/6.11.0/telegram-web-app.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #d32f2f; /* Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø² Ø´Ø¨ÛŒÙ‡ Ø¯ÛŒÙˆØ§Ø± */
            --bg: #f5f5f5;
            --white: #ffffff;
            --text: #333333;
            --gray: #888888;
            --border: #eeeeee;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 70px; user-select: none; }
        
        /* --- Layout --- */
        .page { display: none; padding: 15px; padding-top: 60px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Header --- */
        .header { position: fixed; top: 0; left: 0; right: 0; height: 55px; background: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 100; }
        .search-box { flex: 1; background: var(--bg); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; margin-right: 10px; font-size: 13px; color: var(--gray); }
        .app-title { font-weight: bold; color: var(--primary); font-size: 16px; }

        /* --- Components --- */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .cat-card { background: var(--white); border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .cat-card:active { transform: scale(0.98); }
        .cat-card i { font-size: 24px; color: var(--primary); margin-bottom: 8px; }
        .cat-card span { display: block; font-size: 13px; font-weight: bold; }

        .section-title { font-size: 14px; font-weight: bold; margin: 20px 0 10px; color: var(--text); border-right: 3px solid var(--primary); padding-right: 8px; }

        /* --- Ad List Items --- */
        .ad-card { background: var(--white); border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; gap: 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .ad-img { width: 110px; height: 110px; border-radius: 8px; object-fit: cover; background: #eee; }
        .ad-content { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ad-title { font-weight: bold; font-size: 14px; line-height: 1.4; margin-bottom: 5px; }
        .ad-details { font-size: 11px; color: var(--gray); }
        .ad-price { color: var(--primary); font-weight: bold; font-size: 14px; margin-top: auto; }

        /* --- Forms --- */
        .form-group { background: var(--white); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: var(--gray); margin-bottom: 5px; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; outline: none; font-family: inherit; }
        input:focus, select:focus { border-color: var(--primary); }
        
        .upload-area { border: 2px dashed #ccc; padding: 25px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 15px; }
        .upload-area.has-img { border-style: solid; border-color: var(--primary); padding: 5px; }
        .preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; }

        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 5px; }

        /* --- Bottom Nav --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--white); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 100; }
        .nav-item { text-align: center; font-size: 10px; color: var(--gray); flex: 1; cursor: pointer; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* --- Detail Page --- */
        .detail-hero { width: 100%; height: 250px; object-fit: cover; background: #ddd; }
        .detail-body { padding: 20px; background: var(--white); border-radius: 20px 20px 0 0; margin-top: -20px; position: relative; min-height: 400px; }
        .feature-tag { display: inline-block; background: #f0f0f0; padding: 5px 10px; border-radius: 15px; font-size: 11px; margin-left: 5px; margin-bottom: 5px; color: #555; }
        
        /* Helper Classes */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="app-title">Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡</div>
        <div class="search-box" onclick="alert('Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯')">
            <i class="fa fa-search"></i>
            <span style="margin-right: 8px;">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§...</span>
        </div>
    </div>

    <div id="page-home" class="page active">
        <div class="section-title">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</div>
        <div class="cat-grid">
            <div class="cat-card" onclick="openCategory('estate')">
                <i class="fa fa-home"></i>
                <span>ğŸ  Ø§Ù…Ù„Ø§Ú© Ùˆ Ø®Ø§Ù†Ù‡</span>
            </div>
            <div class="cat-card" onclick="openCategory('goods')">
                <i class="fa fa-shopping-bag"></i>
                <span>ğŸ› Ø§Ø¬Ù†Ø§Ø³ (Ù†Ùˆ/Ø¯Ø³Øª Ø¯ÙˆÙ…)</span>
            </div>
            <div class="cat-card" onclick="openCategory('cars')">
                <i class="fa fa-car"></i>
                <span>ğŸš— Ø§ØªÙˆÙ…Ø¨ÛŒÙ„</span>
            </div>
            <div class="cat-card" onclick="openCategory('jobs')">
                <i class="fa fa-briefcase"></i>
                <span>ğŸ‘·â€â™‚ï¸ Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ú©Ø§Ø±</span>
            </div>
        </div>

        <div class="section-title">Ø¢Ø®Ø±ÛŒÙ† Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±</div>
        <div id="home-ads-container">
            <p style="text-align:center; font-size:12px; color:#999; margin-top:20px;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...</p>
        </div>
    </div>

    <div id="page-list" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="list-header" style="margin:0; font-size:16px;">Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h3>
            <span onclick="switchTab('home')" style="font-size:12px; color:blue;">Ø¨Ø§Ø²Ú¯Ø´Øª</span>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="filter-country" onchange="applyFilters()">
                <option value="all">ğŸŒ Ù‡Ù…Ù‡ Ú©Ø´ÙˆØ±Ù‡Ø§</option>
                <option value="Ø§ÛŒØ±Ø§Ù†">ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†</option>
                <option value="Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†">ğŸ‡¦ğŸ‡« Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</option>
            </select>
            <select id="filter-sort" onchange="applyFilters()">
                <option value="new">ğŸ”¥ Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
                <option value="cheap">ğŸ’° Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
                <option value="expensive">ğŸ’ Ú¯Ø±Ø§Ù†â€ŒØªØ±ÛŒÙ†</option>
            </select>
        </div>

        <div id="category-ads-container"></div>
    </div>

    <div id="page-detail" class="page" style="padding:0; padding-bottom:70px;">
        <img id="d-img" class="detail-hero">
        <div class="detail-body">
            <h2 id="d-title" style="margin-top:0;"></h2>
            <div id="d-price" style="color:var(--primary); font-size:18px; font-weight:bold; margin:10px 0;"></div>
            
            <div style="display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap;" id="d-tags">
                </div>
            
            <div style="display:flex; align-items:center; color:#666; font-size:12px; margin-bottom:20px;">
                <i class="fa fa-map-marker-alt" style="margin-left:5px;"></i>
                <span id="d-loc"></span>
            </div>

            <p style="font-weight:bold; margin-bottom:5px;">ØªÙˆØ¶ÛŒØ­Ø§Øª:</p>
            <p id="d-desc" style="line-height:1.8; color:#444; font-size:13px;"></p>

            <button class="btn" onclick="startChat()">ğŸ’¬ Ú†Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ø§ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>
            <button class="btn btn-outline" onclick="addToFav()">â¤ï¸ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</button>
            <button class="btn btn-outline" style="border:none; color:#666;" onclick="switchTab('home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
    </div>

    <div id="page-add" class="page">
        <h3 style="margin-top:0;">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†</h3>
        
        <div class="form-group">
            <label>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</label>
            <select id="post-cat" onchange="updateFormFields()">
                <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                <option value="estate">ğŸ  Ø§Ù…Ù„Ø§Ú© Ùˆ Ø®Ø§Ù†Ù‡</option>
                <option value="goods">ğŸ› Ø§Ø¬Ù†Ø§Ø³</option>
                <option value="cars">ğŸš— Ø§ØªÙˆÙ…Ø¨ÛŒÙ„</option>
                <option value="jobs">ğŸ‘·â€â™‚ï¸ Ú©Ø§Ø± Ùˆ Ú©Ø§Ø±ÛŒØ§Ø¨ÛŒ</option>
            </select>
        </div>

        <div class="upload-area" onclick="document.getElementById('file-in').click()" id="up-box">
            <i class="fa fa-camera" style="font-size:24px; color:#aaa;"></i>
            <p id="up-txt" style="margin:5px 0; font-size:12px;">Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ Ø¢Ú¯Ù‡ÛŒ</p>
            <img id="up-preview" class="hidden preview-img">
        </div>
        <input type="file" id="file-in" hidden accept="image/*" onchange="handleFileUpload(this)">

        <div id="dynamic-fields" class="form-group hidden">
            </div>

        <div class="form-group">
            <label>Ù…ÙˆÙ‚Ø¹ÛŒØª:</label>
            <div style="display:flex; gap:10px;">
                <select id="post-country">
                    <option value="Ø§ÛŒØ±Ø§Ù†">Ø§ÛŒØ±Ø§Ù†</option>
                    <option value="Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†">Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</option>
                </select>
                <input type="text" id="post-city" placeholder="Ø´Ù‡Ø± (Ù…Ø«Ù„Ø§ Ù‡Ø±Ø§Øª)">
            </div>
            
            <label>Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ:</label>
            <input type="text" id="post-title" placeholder="Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¯Ù‚ÛŒÙ‚">
            
            <label>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù† / Ø§ÙØºØ§Ù†ÛŒ):</label>
            <input type="number" id="post-price" placeholder="0 Ø¨Ø±Ø§ÛŒ ØªÙˆØ§ÙÙ‚ÛŒ">
            
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„:</label>
            <textarea id="post-desc" rows="4"></textarea>
        </div>

        <button class="btn" onclick="submitAd()">Ø§Ù†ØªØ´Ø§Ø± Ø¢Ú¯Ù‡ÛŒ</button>
    </div>

    <div id="page-profile" class="page">
        <div style="text-align:center; margin-bottom:20px;">
            <div style="width:80px; height:80px; background:#ddd; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:30px; color:#fff;">ğŸ‘¤</div>
            <h3 id="user-name-display">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</h3>
            <span style="font-size:12px; color:green;">âœ… ØªØ§ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª Ù†Ø´Ø¯Ù‡</span>
        </div>

        <div class="form-group">
            <div class="section-title" style="margin-top:0;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</div>
            <input type="text" id="prof-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
            <input type="text" id="prof-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
            <input type="text" id="prof-addr" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚">
            <button class="btn btn-outline" onclick="saveProfile()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
        </div>

        <div class="cat-card" style="display:flex; align-items:center; gap:10px; padding:10px; margin-bottom:10px;" onclick="alert('Ù„ÛŒØ³Øª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø§Ø³Øª')">
            <i class="fa fa-heart" style="margin:0; font-size:18px;"></i>
            <span>Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ø´Ø§Ù† Ø´Ø¯Ù‡</span>
        </div>

        <div class="cat-card" style="display:flex; align-items:center; gap:10px; padding:10px;" onclick="alert('Ù„ÛŒØ³Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù† Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø§Ø³Øª')">
            <i class="fa fa-list" style="margin:0; font-size:18px;"></i>
            <span>Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="switchTab('profile')" id="nav-profile">
            <i class="fa fa-user"></i>
            Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
        </div>
        <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
            <i class="fa fa-home"></i>
            Ø®Ø§Ù†Ù‡
        </div>
        <div class="nav-item" onclick="switchTab('add')" id="nav-add">
            <i class="fa fa-plus-circle"></i>
            Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ
        </div>
    </div>

    <script>
        // ğŸ”´ğŸ”´ğŸ”´ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ğŸ”´ğŸ”´ğŸ”´
        const IMGBB_KEY = "cdf0aa3b285e7f59c86497ebeca1ef93"; 
        const BIN_ID = "6967e3d043b1c97be930be0f"; 
        const MASTER_KEY = "$2a$10$qkOl1I02u1dd9Juv25BMv.IsrpbnJq2vYlA.XxkmrvcMdd6G/Iv8q"; // Ú©Ù„ÛŒØ¯ Ø«Ø§Ø¨Øª Ø´Ù…Ø§

        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„
        let currentImgUrl = "";
        let allAdsCache = [];
        let currentAdId = null; // Ø¨Ø±Ø§ÛŒ Ú†Øª

        // --- Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª (SPA) ---
        function switchTab(tabName) {
            // Ø¢Ù¾Ø¯ÛŒØª Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ†
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById(`nav-${tabName}`);
            if(navBtn) navBtn.classList.add('active');

            // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            if(tabName === 'home') {
                document.getElementById('page-home').classList.add('active');
                fetchAds(); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª
            } else if (tabName === 'add') {
                document.getElementById('page-add').classList.add('active');
            } else if (tabName === 'profile') {
                document.getElementById('page-profile').classList.add('active');
                loadProfile();
            }
            window.scrollTo(0,0);
        }

        // --- Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø§Ø¨Ø±ÛŒ ---
        async function fetchAds() {
            const container = document.getElementById('home-ads-container');
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                const data = await res.json();
                allAdsCache = data.record; // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø¨Ø¹Ø¯ÛŒ
                renderAds(allAdsCache.slice(-10).reverse(), 'home-ads-container'); // Ù†Ù…Ø§ÛŒØ´ 10 ØªØ§ÛŒ Ø¢Ø®Ø±
            } catch(e) {
                container.innerHTML = "<p style='text-align:center; color:red;'>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª</p>";
            }
        }

        function renderAds(adsList, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            
            if(adsList.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
                return;
            }

            adsList.forEach(ad => {
                const img = ad.img || "https://via.placeholder.com/150?text=No+Img";
                const html = `
                <div class="ad-card" onclick='openDetail(${JSON.stringify(ad)})'>
                    <img src="${img}" class="ad-img">
                    <div class="ad-content">
                        <div class="ad-title">${ad.title}</div>
                        <div class="ad-details">ğŸ“ ${ad.city} | ${translateCat(ad.cat)}</div>
                        <div class="ad-price">${parseInt(ad.price).toLocaleString()}</div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function translateCat(cat) {
            const map = { 'estate': 'Ø§Ù…Ù„Ø§Ú©', 'goods': 'Ø§Ø¬Ù†Ø§Ø³', 'cars': 'Ø®ÙˆØ¯Ø±Ùˆ', 'jobs': 'Ú©Ø§Ø±' };
            return map[cat] || cat;
        }

        // --- Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø§Øµ ---
        function openCategory(cat) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-list').classList.add('active');
            document.getElementById('list-header').innerText = translateCat(cat);
            
            // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†
            const filtered = allAdsCache.filter(a => a.cat === cat);
            renderAds(filtered.reverse(), 'category-ads-container');
            window.scrollTo(0,0);
        }

        // --- Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ---
        function openDetail(ad) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-detail').classList.add('active');
            
            document.getElementById('d-img').src = ad.img || "";
            document.getElementById('d-title').innerText = ad.title;
            document.getElementById('d-price').innerText = parseInt(ad.price).toLocaleString();
            document.getElementById('d-loc').innerText = `${ad.city} (${ad.country})`;
            document.getElementById('d-desc').innerText = ad.desc;
            
            // Ù†Ù…Ø§ÛŒØ´ ØªÚ¯â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒ
            const tagsBox = document.getElementById('d-tags');
            tagsBox.innerHTML = "";
            if(ad.details) {
                for (const [key, value] of Object.entries(ad.details)) {
                    if(value) tagsBox.innerHTML += `<span class="feature-tag">${key}: ${value}</span>`;
                }
            }

            currentAdId = ad.id; // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ú†Øª
            window.scrollTo(0,0);
        }

        // --- Ú†Øª Ù†Ø§Ø´Ù†Ø§Ø³ ---
        function startChat() {
            if(!currentAdId) return;
            tg.sendData(JSON.stringify({
                action: "chat_request",
                ad_id: currentAdId
            }));
            tg.close(); // Ø¨Ø³ØªÙ† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ Ø¨Ø±Ø§ÛŒ Ø±ÙØªÙ† Ø¨Ù‡ Ú†Øª
        }

        // --- ÙØ±Ù… Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© ---
        function updateFormFields() {
            const cat = document.getElementById('post-cat').value;
            const container = document.getElementById('dynamic-fields');
            container.innerHTML = "";
            container.classList.remove('hidden');

            if(cat === 'estate') {
                container.innerHTML = `
                    <label>Ù†ÙˆØ¹ Ù…Ù„Ú©:</label>
                    <select id="f-type">
                        <option>Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†</option><option>ÙˆÛŒÙ„Ø§ÛŒÛŒ/Ù…Ø³ØªÙ‚Ù„</option>
                        <option>ØªØ¬Ø§Ø±ÛŒ/Ø¯ÙØªØ±</option><option>Ø²Ù…ÛŒÙ†/Ø¨Ø§Øº</option>
                    </select>
                    <label>Ù†ÙˆØ¹ Ù…Ø¹Ø§Ù…Ù„Ù‡:</label>
                    <select id="f-deal"><option>ÙØ±ÙˆØ´</option><option>Ø±Ù‡Ù† Ùˆ Ø§Ø¬Ø§Ø±Ù‡</option></select>
                    <div style="display:flex; gap:10px;">
                        <div><label>Ù…ØªØ±Ø§Ú˜:</label><input type="number" id="f-area"></div>
                        <div><label>Ø§ØªØ§Ù‚:</label><input type="number" id="f-rooms"></div>
                    </div>
                `;
            } else if(cat === 'goods') {
                container.innerHTML = `
                    <label>Ø²ÛŒØ± Ø¯Ø³ØªÙ‡:</label>
                    <select id="f-sub">
                        <option>Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ© (Ù…ÙˆØ¨Ø§ÛŒÙ„/Ù„Ù¾ØªØ§Ù¾)</option><option>Ù„ÙˆØ§Ø²Ù… Ø®Ø§Ù†Ú¯ÛŒ</option>
                        <option>Ù…ØµØ§Ù„Ø­ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ</option><option>Ù„ÙˆØ§Ø²Ù… Ø§Ù„ØªØ­Ø±ÛŒØ±</option>
                    </select>
                    <label>ÙˆØ¶Ø¹ÛŒØª:</label>
                    <select id="f-cond"><option>Ù†Ùˆ (Ø¢Ú©Ø¨Ù†Ø¯)</option><option>Ø¯Ø³Øª Ø¯ÙˆÙ…</option></select>
                    <label>Ù†ÙˆØ¹ ÙØ±ÙˆØ´:</label>
                    <select id="f-sale"><option>ØªÚ©ÛŒ</option><option>Ø¹Ù…Ø¯Ù‡</option></select>
                `;
            } else if(cat === 'cars') {
                container.innerHTML = `
                    <label>Ø¨Ø±Ù†Ø¯:</label><input type="text" id="f-brand" placeholder="Ù…Ø«Ù„Ø§ Ù¾Ø±Ø§ÛŒØ¯, Ø¨Ù†Ø²">
                    <div style="display:flex; gap:10px;">
                        <div><label>Ø³Ø§Ù„:</label><input type="number" id="f-year"></div>
                        <div><label>Ú©Ø§Ø±Ú©Ø±Ø¯:</label><input type="number" id="f-km"></div>
                    </div>
                    <label>ÙˆØ¶Ø¹ÛŒØª Ø¨Ø¯Ù†Ù‡:</label><select id="f-body"><option>Ø³Ø§Ù„Ù…/Ø¨ÛŒâ€ŒØ±Ù†Ú¯</option><option>ØªØµØ§Ø¯ÙÛŒ/Ø±Ù†Ú¯â€ŒØ¯Ø§Ø±</option></select>
                `;
            } else if(cat === 'jobs') {
                container.innerHTML = `
                    <label>Ù†ÙˆØ¹ Ø¢Ú¯Ù‡ÛŒ:</label>
                    <select id="f-jobtype"><option>Ú©Ø§Ø±ÙØ±Ù…Ø§ (Ø¯Ù†Ø¨Ø§Ù„ Ù†ÛŒØ±Ùˆ)</option><option>Ú©Ø§Ø±Ø¬Ùˆ (Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø§Ø±)</option></select>
                    <label>Ø³Ø§Ø¨Ù‚Ù‡ Ú©Ø§Ø± (Ø³Ø§Ù„):</label><input type="number" id="f-exp">
                `;
            } else {
                container.classList.add('hidden');
            }
        }

        // --- Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            document.getElementById('up-txt').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...";
            
            const fd = new FormData();
            fd.append("image", file);
            
            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd })
            .then(r => r.json()).then(d => {
                if(d.success) {
                    currentImgUrl = d.data.url;
                    document.getElementById('up-box').classList.add('has-img');
                    document.getElementById('up-preview').src = currentImgUrl;
                    document.getElementById('up-preview').classList.remove('hidden');
                    document.getElementById('up-txt').innerText = "âœ… Ø¹Ú©Ø³ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯)";
                }
            }).catch(e => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³"));
        }

        // --- Ø§Ø±Ø³Ø§Ù„ Ø¢Ú¯Ù‡ÛŒ ---
        function submitAd() {
            const title = document.getElementById('post-title').value;
            const price = document.getElementById('post-price').value;
            const cat = document.getElementById('post-cat').value;
            
            if(!title || !price || !cat) {
                tg.showPopup({title:'Ù†Ø§Ù‚Øµ', message:'Ù„Ø·ÙØ§ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒØŒ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù‚ÛŒÙ…Øª Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'});
                return;
            }

            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
            let details = {};
            if(cat === 'estate') {
                details = { 'Ù†ÙˆØ¹': document.getElementById('f-type').value, 'Ù…Ø¹Ø§Ù…Ù„Ù‡': document.getElementById('f-deal').value, 'Ù…ØªØ±Ø§Ú˜': document.getElementById('f-area').value };
            } else if(cat === 'goods') {
                details = { 'Ø²ÛŒØ±Ø¯Ø³ØªÙ‡': document.getElementById('f-sub').value, 'ÙˆØ¶Ø¹ÛŒØª': document.getElementById('f-cond').value };
            } else if(cat === 'cars') {
                details = { 'Ø¨Ø±Ù†Ø¯': document.getElementById('f-brand').value, 'Ú©Ø§Ø±Ú©Ø±Ø¯': document.getElementById('f-km').value };
            }

            const data = {
                action: "new_post_full",
                cat: cat,
                title: title,
                price: price,
                desc: document.getElementById('post-desc').value,
                country: document.getElementById('post-country').value,
                city: document.getElementById('post-city').value,
                image_url: currentImgUrl,
                details: details,
                // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ú†Øª
                gps: {lat:0, long:0} 
            };
            
            tg.sendData(JSON.stringify(data));
        }

        // --- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ---
        function loadProfile() {
            const user = JSON.parse(localStorage.getItem('userInfo') || "{}");
            if(user.name) {
                document.getElementById('prof-name').value = user.name;
                document.getElementById('prof-phone').value = user.phone;
                document.getElementById('prof-addr').value = user.address;
                document.getElementById('user-name-display').innerText = user.name;
            }
        }

        function saveProfile() {
            const user = {
                name: document.getElementById('prof-name').value,
                phone: document.getElementById('prof-phone').value,
                address: document.getElementById('prof-addr').value
            };
            localStorage.setItem('userInfo', JSON.stringify(user));
            alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
            loadProfile();
        }

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        fetchAds();
    </script>
</body>
</html>
