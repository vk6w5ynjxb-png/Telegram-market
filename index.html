import logging
import json
import sqlite3
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, WebAppInfo
from telegram.ext import Application, CommandHandler, ContextTypes, MessageHandler, filters

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # Ø­ØªÙ…Ø§ ?v=3 Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ØªØ§ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø¬Ø¨ÙˆØ± Ø´ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯
    web_app_url = "https://vk6w5ynjxb-png.github.io/Telegram-market/index.html?v=3" 
    
    keyboard = [
        [KeyboardButton("ğŸ“± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ (ØªØ³Øª)", web_app=WebAppInfo(url=web_app_url))]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    await update.message.reply_text(
        "Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ ØªØ³Øª Ú©Ù†ÛŒØ¯:",
        reply_markup=reply_markup
    )

# Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…Ø«Ù„ Ø¬Ø§Ø±ÙˆØ¨Ø±Ù‚ÛŒ Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
async def catch_all_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    print("\nğŸ”” >>> ÛŒÚ© Ú†ÛŒØ²ÛŒ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø±Ø³ÛŒØ¯! Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ØªÙˆØ§...")
    
    msg = update.effective_message
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ø¯Ø§Ø¯Ù‡ ÙˆØ¨â€ŒØ§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø®Ù„ Ù¾ÛŒØ§Ù… Ù‡Ø³ØªØŸ
    if msg.web_app_data:
        print("ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø¯Ø§Ø¯Ù‡ ÙˆØ¨â€ŒØ§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!")
        raw_data = msg.web_app_data.data
        print(f"ğŸ“¦ Ù…Ø­ØªÙˆØ§: {raw_data}")
        
        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø°Ø®ÛŒØ±Ù‡
        try:
            data = json.loads(raw_data)
            await msg.reply_text(f"âœ… Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:\n{data['title']} - {data['price']}")
            
            # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            conn = sqlite3.connect('market.db')
            c = conn.cursor()
            # Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯
            c.execute('''CREATE TABLE IF NOT EXISTS ads
                         (user_id INTEGER, title TEXT, price TEXT, description TEXT)''')
            
            c.execute("INSERT INTO ads VALUES (?, ?, ?, ?)", 
                      (update.effective_user.id, data['title'], data['price'], data['description']))
            conn.commit()
            conn.close()
            print("ğŸ’¾ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¬ÛŒØ³ÙˆÙ†: {e}")
    else:
        print("âš ï¸ Ù¾ÛŒØ§Ù…ÛŒ Ø±Ø³ÛŒØ¯ ÙˆÙ„ÛŒ Ø¯Ø§Ø¯Ù‡ ÙˆØ¨â€ŒØ§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù†Ø¨ÙˆØ¯.")
        print(f"Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…: {msg}")

def main():
    # ØªÙˆÚ©Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
    TOKEN = "YOUR_BOT_TOKEN" 
    
    # Ø³Ø§Ø®Øª Ø±Ø¨Ø§Øª
    app = Application.builder().token(TOKEN).job_queue(None).build()
    
    app.add_handler(CommandHandler("start", start))
    
    # Ù†Ú©ØªÙ‡ Ú©Ù„ÛŒØ¯ÛŒ: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² filters.ALL Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù‡Ù…Ù‡ Ú†ÛŒØ²
    app.add_handler(MessageHandler(filters.ALL, catch_all_handler))
    
    print("---------------------------------------")
    print("ğŸ‘€ Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„Øª Ø´Ù†ÙˆØ¯ Ú©Ø§Ù…Ù„ Ø§Ø³Øª (Ø¬Ø§Ø±ÙˆØ¨Ø±Ù‚ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯)")
    print("---------------------------------------")
    
    app.run_polling()

if __name__ == '__main__':
    main()
