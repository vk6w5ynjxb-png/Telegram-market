<script>
        // 1. Ø³ÛŒØ³ØªÙ… Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ (Ù‡Ù…Ø§Ù† Ø§ÙˆÙ„ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        window.onerror = function(message, source, lineno, colno, error) {
            alert("âŒ Ø®Ø·Ø§ÛŒ Ù…Ø±Ú¯Ø¨Ø§Ø±:\n" + message + "\nØ®Ø·: " + lineno);
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        // ğŸ”´ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ (Ø¯Ù‚Øª Ú©Ù†ÛŒØ¯ Ú©ÙˆØªÛŒØ´Ù† Ù‡Ø§ Ù¾Ø§Ú© Ù†Ø´ÙˆØ¯)
        const IMGBB_API_KEY = "cdf0aa3b285e7f59c86497ebeca1ef93"; 

        let uploadedImageUrl = "";

        // Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        const SAMPLE_ADS = [
            { id: 1, title: "Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡", price: "5,000,000,000", city: "ØªÙ‡Ø±Ø§Ù†", cat: "estate", country: "Ø§ÛŒØ±Ø§Ù†", img: "https://picsum.photos/300/200", desc: "ØªØ³Øª" },
            { id: 2, title: "Ú¯ÙˆØ´ÛŒ Ù†Ù…ÙˆÙ†Ù‡", price: "40,000,000", city: "Ú©Ø§Ø¨Ù„", cat: "goods", country: "Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†", img: "https://picsum.photos/300/201", desc: "ØªØ³Øª" }
        ];

        function showPage(id) {
            try {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const target = document.getElementById(id);
                if(target) target.classList.add('active');
                window.scrollTo(0,0);
            } catch(e) { alert("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ØµÙØ­Ù‡: " + e); }
        }

        function loadAds(cat, country) {
            try {
                document.getElementById('list-title').innerText = `${cat === 'estate' ? 'Ø§Ù…Ù„Ø§Ú©' : 'Ø§Ø¬Ù†Ø§Ø³'} - ${country}`;
                const container = document.getElementById('ads-container');
                container.innerHTML = "";

                const mySavedAds = JSON.parse(localStorage.getItem('myAds') || "[]");
                const allAds = [...mySavedAds, ...SAMPLE_ADS];
                const filtered = allAds.filter(ad => ad.cat === cat && ad.country === country);

                if (filtered.length === 0) {
                    container.innerHTML = "<p style='text-align:center; color:#888; margin-top:50px;'>Ø¢Ú¯Ù‡ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>";
                }

                filtered.reverse().forEach(ad => {
                    const imgSrc = ad.img || "https://via.placeholder.com/100?text=No+Image";
                    const item = `
                        <div class="ad-item" onclick="showDetail('${ad.id}')">
                            <img src="${imgSrc}" class="ad-img">
                            <div class="ad-info">
                                <div class="ad-title">${ad.title}</div>
                                <div class="ad-loc"><i class="fa fa-map-marker-alt"></i> ${ad.city}</div>
                                <div class="ad-price">${parseInt(ad.price).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += item;
                });
                showPage('page-list');
            } catch(e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ø¢Ú¯Ù‡ÛŒ: " + e); }
        }

        function showDetail(id) {
            const mySavedAds = JSON.parse(localStorage.getItem('myAds') || "[]");
            const allAds = [...mySavedAds, ...SAMPLE_ADS];
            const ad = allAds.find(a => a.id == id);
            
            if (!ad) return;

            document.getElementById('d-img').src = ad.img || "https://via.placeholder.com/300?text=No+Image";
            document.getElementById('d-title').innerText = ad.title;
            document.getElementById('d-price').innerText = parseInt(ad.price).toLocaleString();
            document.getElementById('d-loc').innerText = `ğŸ“ ${ad.city} (${ad.country})`;
            document.getElementById('d-desc').innerText = ad.desc;

            showPage('page-detail');
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const div = document.getElementById('upload-div');
            const txt = document.getElementById('upload-text');
            txt.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...";
            
            const formData = new FormData();
            formData.append("image", file);

            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    uploadedImageUrl = data.data.url;
                    div.classList.add('uploaded');
                    div.innerHTML = `<img src="${uploadedImageUrl}" style="width:100%; height:100px; object-fit:cover; border-radius:8px;">`;
                } else {
                    alert("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ± Ø¹Ú©Ø³: " + data.error.message);
                    txt.innerText = "Ø®Ø·Ø§!";
                }
            })
            .catch(err => alert("Ø®Ø·Ø§ÛŒ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³"));
        }

        function submitAd() {
            try {
                const title = document.getElementById('title').value;
                const price = document.getElementById('price').value;
                const city = document.getElementById('city').value;
                const country = document.getElementById('country').value;
                const cat = document.getElementById('cat').value;
                const desc = document.getElementById('desc').value;

                if(!title || !price || !city) {
                    tg.showPopup({title:'Ø®Ø·Ø§', message:'Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'});
                    return;
                }

                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú¯ÙˆØ´ÛŒ
                const newAd = {
                    id: Date.now(),
                    title: title,
                    price: price,
                    city: city,
                    country: country,
                    cat: cat,
                    desc: desc,
                    img: uploadedImageUrl,
                    address: document.getElementById('full-addr').value
                };

                const existingAds = JSON.parse(localStorage.getItem('myAds') || "[]");
                existingAds.push(newAd);
                localStorage.setItem('myAds', JSON.stringify(existingAds));

                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø±Ø¨Ø§Øª
                const data = {
                    action: "new_post_full",
                    title: title,
                    price: price,
                    city: city,
                    country: country,
                    address: newAd.address,
                    desc: desc,
                    cat: cat,
                    image_url: uploadedImageUrl,
                    details: {},
                    gps: {lat:0, long:0}
                };

                tg.sendData(JSON.stringify(data));
            } catch(e) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„: " + e);
            }
        }
    </script>
