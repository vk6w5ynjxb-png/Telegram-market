<script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ğŸ”´ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
        const IMGBB_API_KEY = "YOUR_API_KEY"; 

        let uploadedImageUrl = "";

        // Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (ØªØ³Øª)
        const SAMPLE_ADS = [
            { id: 1, title: "Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù† 100 Ù…ØªØ±ÛŒ", price: "5,000,000,000", city: "ØªÙ‡Ø±Ø§Ù†", cat: "estate", country: "Ø§ÛŒØ±Ø§Ù†", img: "https://picsum.photos/300/200", desc: "ØªØ³Øª" },
            { id: 2, title: "Ø¢ÛŒÙÙˆÙ† 13", price: "40,000,000", city: "Ù…Ø´Ù‡Ø¯", cat: "goods", country: "Ø§ÛŒØ±Ø§Ù†", img: "https://picsum.photos/300/201", desc: "ØªØ³Øª" }
        ];

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        // --- ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ ---
        function loadAds(cat, country) {
            document.getElementById('list-title').innerText = `${cat === 'estate' ? 'Ø§Ù…Ù„Ø§Ú©' : 'Ø§Ø¬Ù†Ø§Ø³'} - ${country}`;
            const container = document.getElementById('ads-container');
            container.innerHTML = "";

            // 1. Ø®ÙˆØ§Ù†Ø¯Ù† Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø´Ù…Ø§ (Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ú¯ÙˆØ´ÛŒ)
            const mySavedAds = JSON.parse(localStorage.getItem('myAds') || "[]");

            // 2. ØªØ±Ú©ÛŒØ¨ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
            const allAds = [...mySavedAds, ...SAMPLE_ADS];

            // 3. ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†
            const filtered = allAds.filter(ad => ad.cat === cat && ad.country === country);

            if (filtered.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#888; margin-top:50px;'>Ù‡Ù†ÙˆØ² Ø¢Ú¯Ù‡ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†ÛŒØ³Øª.</p>";
            }

            // 4. Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª (Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ØªØ± Ø§ÙˆÙ„ Ø¨ÛŒØ§ÛŒÙ†Ø¯)
            filtered.reverse().forEach(ad => {
                // Ø§Ú¯Ø± Ø¹Ú©Ø³ Ù†Ø¯Ø§Ø´ØªØŒ ÛŒÚ© Ø¹Ú©Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ú¯Ø°Ø§Ø±
                const imgSrc = ad.img || "https://via.placeholder.com/100?text=No+Image";
                
                const item = `
                    <div class="ad-item" onclick="showDetail('${ad.id}')">
                        <img src="${imgSrc}" class="ad-img">
                        <div class="ad-info">
                            <div class="ad-title">${ad.title}</div>
                            <div class="ad-loc"><i class="fa fa-map-marker-alt"></i> ${ad.city}</div>
                            <div class="ad-price">${parseInt(ad.price).toLocaleString()}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += item;
            });

            showPage('page-list');
        }

        function showDetail(id) {
            // Ø¬Ø³ØªØ¬Ùˆ Ù‡Ù… Ø¯Ø± Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ Ù‡Ù… Ø¯Ø± Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ
            const mySavedAds = JSON.parse(localStorage.getItem('myAds') || "[]");
            const allAds = [...mySavedAds, ...SAMPLE_ADS];
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ú¯Ù‡ÛŒ (ØªÙˆØ¬Ù‡: id Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¹Ø¯Ø¯ ÛŒØ§ Ø±Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ù¾Ø³ == Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… Ù†Ù‡ ===)
            const ad = allAds.find(a => a.id == id);
            
            if (!ad) return;

            document.getElementById('d-img').src = ad.img || "https://via.placeholder.com/300?text=No+Image";
            document.getElementById('d-title').innerText = ad.title;
            document.getElementById('d-price').innerText = parseInt(ad.price).toLocaleString();
            document.getElementById('d-loc').innerText = `ğŸ“ ${ad.city} (${ad.country})`;
            document.getElementById('d-desc').innerText = ad.desc;

            showPage('page-detail');
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const div = document.getElementById('upload-div');
            const txt = document.getElementById('upload-text');
            txt.innerText = "â³ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...";
            
            const formData = new FormData();
            formData.append("image", file);

            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    uploadedImageUrl = data.data.url;
                    div.classList.add('uploaded');
                    div.innerHTML = `<img src="${uploadedImageUrl}" style="width:100%; height:100px; object-fit:cover; border-radius:8px;">`;
                } else {
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³");
                }
            })
            .catch(err => alert("Ø®Ø·Ø§ÛŒ Ø§ÛŒÙ†ØªØ±Ù†Øª"));
        }

        function submitAd() {
            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            const city = document.getElementById('city').value;
            const country = document.getElementById('country').value;
            const cat = document.getElementById('cat').value;
            const desc = document.getElementById('desc').value;

            if(!title || !price || !city) {
                tg.showPopup({title:'Ø®Ø·Ø§', message:'Ù„Ø·ÙØ§ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'});
                return;
            }

            // --- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ú¯ÙˆØ´ÛŒ (LocalStorage) ---
            const newAd = {
                id: Date.now(), // ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†
                title: title,
                price: price,
                city: city,
                country: country,
                cat: cat,
                desc: desc,
                img: uploadedImageUrl, // Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³ÛŒ Ú©Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯
                address: document.getElementById('full-addr').value
            };

            // 1. Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù‚Ø¨Ù„ÛŒ
            const existingAds = JSON.parse(localStorage.getItem('myAds') || "[]");
            // 2. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯
            existingAds.push(newAd);
            // 3. Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¬Ø¯Ø¯
            localStorage.setItem('myAds', JSON.stringify(existingAds));
            // -----------------------------------------------------

            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø±Ø¨Ø§Øª (Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ùˆ Ø¯ÛŒØªØ§Ø¨ÛŒØ³)
            const data = {
                action: "new_post_full",
                title: title,
                price: price,
                city: city,
                country: country,
                address: newAd.address,
                desc: desc,
                cat: cat,
                image_url: uploadedImageUrl,
                details: {},
                gps: {lat:0, long:0}
            };

            tg.sendData(JSON.stringify(data));
        }
    </script>
