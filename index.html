<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main: #2b95ff; --bg: var(--tg-theme-bg-color, #fff); --text: var(--tg-theme-text-color, #000); --sec: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        
        /* ØµÙØ­Ø§Øª (ØªØ¨â€ŒÙ‡Ø§) */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card { background: var(--sec); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        h3 { margin: 0 0 10px; font-size: 15px; color: var(--main); border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ */
        .big-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 16px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; color: var(--text); }
        .big-btn i { font-size: 20px; color: var(--main); }

        /* ÙØ±Ù…â€ŒÙ‡Ø§ */
        label { display: block; margin: 10px 0 5px; font-size: 12px; color: #888; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: var(--bg); color: var(--text); box-sizing: border-box; }

        /* Ø¯Ú©Ù…Ù‡ Ù„ÙˆÚ©ÛŒØ´Ù† */
        .loc-btn { width: 100%; padding: 12px; background: #00a65a; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ */
        .submit-btn { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 10px; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>ğŸ› Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>
            <p style="font-size: 12px; color: #888;">Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ø¯Ø± Ø§ÛŒØ±Ø§Ù† Ùˆ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</p>
        </div>

        <h3>ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h3>
        <button class="big-btn" onclick="goToSearch('estate')">
            <span>ğŸ  Ø§Ù…Ù„Ø§Ú©</span> <i class="fa fa-chevron-left"></i>
        </button>
        <button class="big-btn" onclick="goToSearch('goods')">
            <span>ğŸ› Ø§Ø¬Ù†Ø§Ø³ (Ù†Ùˆ/Ø¯Ø³Øª Ø¯ÙˆÙ…)</span> <i class="fa fa-chevron-left"></i>
        </button>

        <h3 style="margin-top: 20px;">â• Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</h3>
        <button class="big-btn" style="background: #e3f2fd;" onclick="goToPost()">
            <span>ğŸ“ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯</span> <i class="fa fa-plus-circle"></i>
        </button>
    </div>

    <div id="page-search-country" class="page">
        <h3>ğŸŒ Ø¯Ø± Ú©Ø¯Ø§Ù… Ú©Ø´ÙˆØ± Ù‡Ø³ØªÛŒØ¯ØŸ</h3>
        <button class="big-btn" onclick="doSearch('Ø§ÛŒØ±Ø§Ù†')">ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†</button>
        <button class="big-btn" onclick="doSearch('Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†')">ğŸ‡¦ğŸ‡« Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</button>
        <button class="big-btn" style="background:none; box-shadow:none; color: #888;" onclick="showPage('page-home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="page-post" class="page">
        <div class="card">
            <h3>ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ</h3>
            <button class="loc-btn" type="button" onclick="getLocation()">
                <i class="fa fa-map-marker-alt"></i> Ø¯Ø±ÛŒØ§ÙØª Ù„ÙˆÚ©ÛŒØ´Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
            </button>
            <div id="loc-status" style="font-size: 11px; color: green; margin-bottom: 10px;"></div>

            <label>Ú©Ø´ÙˆØ±:</label>
            <select id="addr-country">
                <option value="Ø§ÛŒØ±Ø§Ù†">ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†</option>
                <option value="Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†">ğŸ‡¦ğŸ‡« Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</option>
            </select>

            <div style="display: flex; gap: 5px;">
                <div style="flex:1"><label>Ø§Ø³ØªØ§Ù†/ÙˆÙ„Ø§ÛŒØª:</label><input type="text" id="addr-prov"></div>
                <div style="flex:1"><label>Ø´Ù‡Ø±:</label><input type="text" id="addr-city"></div>
            </div>
            <label>Ù…Ø­Ù„Ù‡:</label><input type="text" id="addr-dist">
            <label>Ø®ÛŒØ§Ø¨Ø§Ù† Ø§ØµÙ„ÛŒ:</label><input type="text" id="addr-street">
            <label>Ù¾Ù„Ø§Ú©/Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±Ø¨:</label><input type="text" id="addr-no">
        </div>

        <div class="card">
            <h3>ğŸ“‚ Ù…Ø´Ø®ØµØ§Øª Ø¢Ú¯Ù‡ÛŒ</h3>
            <label>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</label>
            <select id="cat-select" onchange="toggleForm(this.value)">
                <option value="estate">ğŸ  Ø§Ù…Ù„Ø§Ú©</option>
                <option value="goods">ğŸ› Ø§Ø¬Ù†Ø§Ø³</option>
            </select>

            <div id="form-estate">
                <label>Ù†ÙˆØ¹ Ù…Ù„Ú©:</label>
                <select id="est-type"><option>Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†</option><option>ÙˆÛŒÙ„Ø§ÛŒÛŒ</option><option>Ø²Ù…ÛŒÙ†</option></select>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1"><label>Ù…ØªØ±Ø§Ú˜:</label><input type="number" id="est-area"></div>
                    <div style="flex:1"><label>Ø³Ù† Ø¨Ù†Ø§:</label><input type="number" id="est-age"></div>
                </div>
            </div>

            <div id="form-goods" class="hidden">
                <label>Ù†ÙˆØ¹ Ú©Ø§Ù„Ø§:</label>
                <select id="g-type"><option>Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ</option><option>Ø®Ø§Ù†Ú¯ÛŒ</option><option>Ø®ÙˆØ¯Ø±Ùˆ</option></select>
                <label>ÙˆØ¶Ø¹ÛŒØª:</label>
                <select id="g-status"><option>Ù†Ùˆ (ØµÙØ±)</option><option>Ø¯Ø³Øª Ø¯ÙˆÙ…</option></select>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù†Ù‡Ø§ÛŒÛŒ</h3>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ:</label><input type="text" id="title">
            <label>Ù‚ÛŒÙ…Øª:</label><input type="tel" id="price">
            <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label><textarea id="desc" rows="2"></textarea>
            
            <div style="margin-top:15px; padding:10px; background:#e8f5e9; border-radius:8px; font-size:12px; color:#2e7d32;">
                ğŸ–¼ <b>ØªØµÙˆÛŒØ± Ø¢Ú¯Ù‡ÛŒ:</b> Ø¬Ù‡Øª Ø¢Ù¾Ù„ÙˆØ¯ Ø³Ø±ÛŒØ¹â€ŒØªØ±ØŒ ØªØµÙˆÛŒØ± Ø±Ø§ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ (Ø¯Ø§Ø®Ù„ Ø±Ø¨Ø§Øª) Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø±Ø¯.
            </div>
        </div>

        <button class="submit-btn" onclick="submitAd()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³</button>
        <button class="big-btn" style="background:none; box-shadow:none; color:#888; margin-top:10px;" onclick="showPage('page-home')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let searchCategory = '';
        // Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±ÙˆØ±
        let userLat = 0.0;
        let userLong = 0.0;

        function showPage(pageId) {
            // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ØµÙØ­Ø§Øª
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.add('active');
            } else {
                alert("Ø®Ø·Ø§: ØµÙØ­Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ " + pageId);
            }
        }

        // --- Ø¨Ø®Ø´ Ø¬Ø³ØªØ¬Ùˆ ---
        function goToSearch(cat) {
            searchCategory = cat;
            showPage('page-search-country');
        }

        function doSearch(country) {
            try {
                const data = {
                    action: "search_ads",
                    category: searchCategory,
                    country: country
                };
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: " + e);
            }
        }

        // --- Ø¨Ø®Ø´ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ ---
        function goToPost() { showPage('page-post'); }

        function toggleForm(cat) {
            const estateForm = document.getElementById('form-estate');
            const goodsForm = document.getElementById('form-goods');
            
            if (cat === 'estate') {
                estateForm.classList.remove('hidden');
                goodsForm.classList.add('hidden');
            } else {
                estateForm.classList.add('hidden');
                goodsForm.classList.remove('hidden');
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                tg.MainButton.showProgress();
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLong = position.coords.longitude;
                    document.getElementById('loc-status').innerText = "âœ… Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯";
                    document.getElementById('loc-status').style.color = "green";
                    tg.MainButton.hideProgress();
                }, function(error) {
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÙˆÚ©ÛŒØ´Ù†: " + error.message + "\n(Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÙˆÙ† Ù„ÙˆÚ©ÛŒØ´Ù†)");
                    document.getElementById('loc-status').innerText = "âš ï¸ Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø«Ø¨Øª Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø´Ù‡)";
                    document.getElementById('loc-status').style.color = "orange";
                    tg.MainButton.hideProgress();
                });
            } else {
                alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
            }
        }

        function submitAd() {
            try {
                // 1. Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ
                const title = document.getElementById('title').value;
                const price = document.getElementById('price').value;
                const city = document.getElementById('addr-city').value;
                const country = document.getElementById('addr-country').value;

                if (!title || !price || !city) {
                    tg.showPopup({title: 'Ø®Ø·Ø§', message: 'Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù‚ÛŒÙ…Øª Ùˆ Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'});
                    return;
                }

                // 2. Ø³Ø§Ø®Øª Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
                const cat = document.getElementById('cat-select').value;
                let details = {};
                
                if(cat === 'estate') {
                    details = { 
                        type: document.getElementById('est-type').value,
                        area: document.getElementById('est-area').value || "0", // Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ 0 Ø¨Ú¯Ø°Ø§Ø±
                        age: document.getElementById('est-age').value || "0"
                    };
                } else {
                    details = {
                        type: document.getElementById('g-type').value,
                        status: document.getElementById('g-status').value
                    };
                }

                // 3. Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢Ø¯Ø±Ø³ (Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§)
                const addressData = {
                    country: country,
                    province: document.getElementById('addr-prov').value || "-",
                    city: city,
                    dist: document.getElementById('addr-dist').value || "-",
                    street: document.getElementById('addr-street').value || "-",
                    no: document.getElementById('addr-no').value || "-",
                    gps: { lat: userLat, long: userLong }
                };

                // 4. Ø³Ø§Ø®Øª Ù¾Ú©ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
                const finalData = {
                    action: "new_post",
                    category: cat,
                    address: addressData,
                    title: title,
                    price: price,
                    desc: document.getElementById('desc').value || "Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª",
                    details: details
                };

                // 5. Ø§Ø±Ø³Ø§Ù„ (Ù…Ù‡Ù…ØªØ±ÛŒÙ† Ø¨Ø®Ø´)
                // Ù†Ù…Ø§ÛŒØ´ ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
                tg.MainButton.showProgress();
                tg.sendData(JSON.stringify(finalData));
                
            } catch (err) {
                // Ø§Ú¯Ø± Ù‡Ø± Ø®Ø·Ø§ÛŒÛŒ Ø¨Ø§Ø´Ø¯ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                alert("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ: " + err.message);
                tg.MainButton.hideProgress();
            }
        }
    </script>
