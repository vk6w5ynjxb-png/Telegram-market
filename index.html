<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÛŒÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main: #a62626; --bg: #fff; --text: #000; --sec: #f2f2f2; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        
        .page { display: none; }
        .page.active { display: block; }

        .card { background: var(--sec); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        h3 { margin: 0 0 15px; font-size: 14px; color: var(--main); border-bottom: 2px solid #ddd; display: inline-block; padding-bottom: 5px; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .big-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .submit-btn { width: 100%; padding: 15px; background: var(--main); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }

        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ */
        .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; background: white; cursor: pointer; transition: 0.3s; }
        .upload-box.uploaded { border-color: green; background: #e8f5e9; }
        .upload-box i { font-size: 30px; color: #888; margin-bottom: 10px; }
        #file-input { display: none; }
        #upload-status { font-size: 12px; color: #666; margin-top: 5px; }

        .loading { display: inline-block; width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="color: var(--main);">ğŸ›’ Ø¨Ø§Ø²Ø§Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†</h2>
        </div>
        
        <h3>Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h3>
        <button class="big-btn" onclick="sendSearch('estate', 'Ø§ÛŒØ±Ø§Ù†')"><span>ğŸ  Ø§Ù…Ù„Ø§Ú© Ø§ÛŒØ±Ø§Ù†</span> <i class="fa fa-angle-left"></i></button>
        <button class="big-btn" onclick="sendSearch('estate', 'Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†')"><span>ğŸ  Ø§Ù…Ù„Ø§Ú© Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</span> <i class="fa fa-angle-left"></i></button>
        <button class="big-btn" onclick="sendSearch('goods', 'Ø§ÛŒØ±Ø§Ù†')"><span>ğŸ› Ø§Ø¬Ù†Ø§Ø³ Ø§ÛŒØ±Ø§Ù†</span> <i class="fa fa-angle-left"></i></button>
        <button class="big-btn" onclick="sendSearch('goods', 'Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†')"><span>ğŸ› Ø§Ø¬Ù†Ø§Ø³ Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</span> <i class="fa fa-angle-left"></i></button>

        <h3 style="margin-top: 20px;">Ø«Ø¨Øª</h3>
        <button class="big-btn" style="background: var(--main); color: white;" onclick="showPage('page-post')">
            <span>ğŸ“ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯</span> <i class="fa fa-plus-circle"></i>
        </button>
    </div>

    <div id="page-post" class="page">
        <div class="card">
            <h3>ğŸ“¸ ØªØµÙˆÛŒØ± Ø¢Ú¯Ù‡ÛŒ</h3>
            <div class="upload-box" onclick="document.getElementById('file-input').click()" id="upload-div">
                <i class="fa fa-camera"></i><br>
                <span>Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯</span>
            </div>
            <input type="file" id="file-input" accept="image/*" onchange="handleFile(this)">
            <div id="upload-status">Ù‡Ù†ÙˆØ² Ø¹Ú©Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
        </div>

        <div class="card">
            <h3>ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª</h3>
            <button class="big-btn" onclick="getLocation()" style="background:#0088cc; color:white; justify-content:center;">
                <i class="fa fa-map-marker-alt" style="margin-left:5px;"></i> Ø¯Ø±ÛŒØ§ÙØª Ù„ÙˆÚ©ÛŒØ´Ù† Ù…Ù†
            </button>
            <div id="loc-txt" style="font-size:11px; color:green; margin-bottom:10px; text-align:center;"></div>
            
            <select id="country">
                <option value="Ø§ÛŒØ±Ø§Ù†">Ø§ÛŒØ±Ø§Ù†</option>
                <option value="Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†">Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</option>
            </select>
            <input type="text" id="city" placeholder="Ø´Ù‡Ø± (Ù…Ø«Ù„Ø§: ØªÙ‡Ø±Ø§Ù†)">
            <input type="text" id="full-addr" placeholder="Ù…Ø­Ù„Ù‡ØŒ Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ù¾Ù„Ø§Ú©">
        </div>

        <div class="card">
            <h3>ğŸ“¦ Ù…Ø´Ø®ØµØ§Øª</h3>
            <select id="cat" onchange="toggleForm(this.value)">
                <option value="estate">Ø§Ù…Ù„Ø§Ú©</option>
                <option value="goods">Ø§Ø¬Ù†Ø§Ø³</option>
            </select>

            <div id="form-estate">
                <input type="text" id="est-type" placeholder="Ù†ÙˆØ¹ Ù…Ù„Ú© (Ø¢Ù¾Ø§Ø±ØªÙ…Ø§Ù†/ÙˆÛŒÙ„Ø§)">
                <input type="number" id="est-area" placeholder="Ù…ØªØ±Ø§Ú˜">
            </div>
            <div id="form-goods" style="display:none;">
                <input type="text" id="g-type" placeholder="Ù†ÙˆØ¹ Ú©Ø§Ù„Ø§ (Ù…ÙˆØ¨Ø§ÛŒÙ„/Ù„Ù¾ØªØ§Ù¾)">
                <select id="g-status"><option>Ù†Ùˆ</option><option>Ø¯Ø³Øª Ø¯ÙˆÙ…</option></select>
            </div>

            <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ">
            <input type="number" id="price" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)">
            <textarea id="desc" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª..."></textarea>
        </div>

        <button class="submit-btn" id="btn-submit" onclick="submitAd()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ú¯Ù‡ÛŒ</button>
        <button class="big-btn" onclick="showPage('page-home')" style="margin-top:10px; text-align:center; justify-content:center; color:#888;">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ğŸ”´ğŸ”´ğŸ”´ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ğŸ”´ğŸ”´ğŸ”´
        const IMGBB_API_KEY = "cdf0aa3b285e7f59c86497ebeca1ef93"; 

        let userLoc = { lat: 0, long: 0 };
        let uploadedImageUrl = "";

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toggleForm(cat) {
            document.getElementById('form-estate').style.display = (cat === 'estate') ? 'block' : 'none';
            document.getElementById('form-goods').style.display = (cat === 'goods') ? 'block' : 'none';
        }

        function getLocation() {
            if(navigator.geolocation) {
                tg.MainButton.showProgress();
                navigator.geolocation.getCurrentPosition(p => {
                    userLoc = { lat: p.coords.latitude, long: p.coords.longitude };
                    document.getElementById('loc-txt').innerText = "âœ… Ù„ÙˆÚ©ÛŒØ´Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯";
                    tg.MainButton.hideProgress();
                }, e => {
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆÚ©ÛŒØ´Ù†: " + e.message);
                    tg.MainButton.hideProgress();
                });
            }
        }

        // Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ Ø¯Ø± ImgBB
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('upload-status');
            const div = document.getElementById('upload-div');
            
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯... Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯";
            status.style.color = "blue";
            document.getElementById('btn-submit').disabled = true; // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª

            const formData = new FormData();
            formData.append("image", file);

            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    uploadedImageUrl = result.data.url; // Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¹Ú©Ø³
                    status.innerText = "âœ… Ø¹Ú©Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯!";
                    status.style.color = "green";
                    div.classList.add('uploaded');
                    div.innerHTML = `<img src="${uploadedImageUrl}" style="width:100%; height:100px; object-fit:cover; border-radius:8px;">`;
                    document.getElementById('btn-submit').disabled = false; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡
                } else {
                    status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: " + result.error.message;
                    status.style.color = "red";
                }
            })
            .catch(error => {
                status.innerText = "âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡";
                console.error(error);
            });
        }

        function submitAd() {
            const title = document.getElementById('title').value;
            const price = document.getElementById('price').value;
            const city = document.getElementById('city').value;

            if(!title || !price || !city) {
                tg.showPopup({title: 'Ø®Ø·Ø§', message: 'Ù„Ø·ÙØ§ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù‚ÛŒÙ…Øª Ùˆ Ø´Ù‡Ø± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'});
                return;
            }

            const cat = document.getElementById('cat').value;
            let details = {};
            if(cat === 'estate') {
                details = { type: document.getElementById('est-type').value, area: document.getElementById('est-area').value };
            } else {
                details = { type: document.getElementById('g-type').value, status: document.getElementById('g-status').value };
            }

            const data = {
                action: "new_post_full", // Ø§Ú©Ø´Ù† Ø¬Ø¯ÛŒØ¯
                title: title,
                price: price,
                city: city,
                country: document.getElementById('country').value,
                address: document.getElementById('full-addr').value,
                desc: document.getElementById('desc').value,
                cat: cat,
                details: details,
                gps: userLoc,
                image_url: uploadedImageUrl // Ù„ÛŒÙ†Ú© Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ÛŒ
            };

            tg.sendData(JSON.stringify(data));
        }

        function sendSearch(cat, country) {
            tg.sendData(JSON.stringify({ action: "search_ads", category: cat, country: country }));
        }
    </script>
</body>
</html>
