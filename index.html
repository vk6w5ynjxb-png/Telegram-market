    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let searchCategory = '';
        // مقادیر پیش‌فرض برای جلوگیری از ارور
        let userLat = 0.0;
        let userLong = 0.0;

        function showPage(pageId) {
            // مخفی کردن همه صفحات
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // نمایش صفحه مورد نظر
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.add('active');
            } else {
                alert("خطا: صفحه پیدا نشد " + pageId);
            }
        }

        // --- بخش جستجو ---
        function goToSearch(cat) {
            searchCategory = cat;
            showPage('page-search-country');
        }

        function doSearch(country) {
            try {
                const data = {
                    action: "search_ads",
                    category: searchCategory,
                    country: country
                };
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                alert("خطا در جستجو: " + e);
            }
        }

        // --- بخش ثبت آگهی ---
        function goToPost() { showPage('page-post'); }

        function toggleForm(cat) {
            const estateForm = document.getElementById('form-estate');
            const goodsForm = document.getElementById('form-goods');
            
            if (cat === 'estate') {
                estateForm.classList.remove('hidden');
                goodsForm.classList.add('hidden');
            } else {
                estateForm.classList.add('hidden');
                goodsForm.classList.remove('hidden');
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                tg.MainButton.showProgress();
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLong = position.coords.longitude;
                    document.getElementById('loc-status').innerText = "✅ موقعیت دریافت شد";
                    document.getElementById('loc-status').style.color = "green";
                    tg.MainButton.hideProgress();
                }, function(error) {
                    alert("خطا در دریافت لوکیشن: " + error.message + "\n(ادامه بدون لوکیشن)");
                    document.getElementById('loc-status').innerText = "⚠️ لوکیشن دریافت نشد (ثبت بدون نقشه)";
                    document.getElementById('loc-status').style.color = "orange";
                    tg.MainButton.hideProgress();
                });
            } else {
                alert("مرورگر پشتیبانی نمی‌کند.");
            }
        }

        function submitAd() {
            try {
                // 1. دریافت و بررسی فیلدهای اجباری
                const title = document.getElementById('title').value;
                const price = document.getElementById('price').value;
                const city = document.getElementById('addr-city').value;
                const country = document.getElementById('addr-country').value;

                if (!title || !price || !city) {
                    tg.showPopup({title: 'خطا', message: 'لطفاً عنوان، قیمت و شهر را وارد کنید.'});
                    return;
                }

                // 2. ساخت جزئیات بر اساس دسته‌بندی
                const cat = document.getElementById('cat-select').value;
                let details = {};
                
                if(cat === 'estate') {
                    details = { 
                        type: document.getElementById('est-type').value,
                        area: document.getElementById('est-area').value || "0", // اگر خالی بود 0 بگذار
                        age: document.getElementById('est-age').value || "0"
                    };
                } else {
                    details = {
                        type: document.getElementById('g-type').value,
                        status: document.getElementById('g-status').value
                    };
                }

                // 3. جمع‌آوری آدرس (با بررسی خطا)
                const addressData = {
                    country: country,
                    province: document.getElementById('addr-prov').value || "-",
                    city: city,
                    dist: document.getElementById('addr-dist').value || "-",
                    street: document.getElementById('addr-street').value || "-",
                    no: document.getElementById('addr-no').value || "-",
                    gps: { lat: userLat, long: userLong }
                };

                // 4. ساخت پکیج نهایی
                const finalData = {
                    action: "new_post",
                    category: cat,
                    address: addressData,
                    title: title,
                    price: price,
                    desc: document.getElementById('desc').value || "بدون توضیحات",
                    details: details
                };

                // 5. ارسال (مهمترین بخش)
                // نمایش یک پیام تایید قبل از ارسال برای اطمینان
                tg.MainButton.showProgress();
                tg.sendData(JSON.stringify(finalData));
                
            } catch (err) {
                // اگر هر خطایی باشد اینجا نمایش داده می‌شود
                alert("❌ خطای سیستمی: " + err.message);
                tg.MainButton.hideProgress();
            }
        }
    </script>
